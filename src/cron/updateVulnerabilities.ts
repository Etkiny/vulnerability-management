import cron from 'node-cron';
import vulnerabilityService from '../services/vulnerabilities.service';
import notificationsService from 'services/notifications.service';

let vulnerabilityCronJob: cron.ScheduledTask;

const startVulnerabilityCronJob = () => {
    vulnerabilityCronJob = cron.schedule('0 2 * * *', async () => {
        console.log('Starting daily vulnerability sync job');

        try {
            await vulnerabilityService.updateVulnerabilities();
            await notificationsService.checkAndSendNotifications();
            console.log('Vulnerabilities updated and sent successfully');
        } catch (error) {
            console.error('Error updating vulnerabilities', error);
        }
    });
};

const triggerCronJobManually = async () => {
    console.log('Manually triggering cron job');
    if (vulnerabilityCronJob) {
        vulnerabilityCronJob.stop();
        try {
            await vulnerabilityService.updateVulnerabilities();
            await notificationsService.checkAndSendNotifications();
            console.log('Vulnerabilities updated and sent successfully');
        } catch (error) {
            console.error('Error updating vulnerabilities', error);
        }
        vulnerabilityCronJob.start();
    } else {
        console.error('Cron job is not initialized');
    }
};

export { startVulnerabilityCronJob, triggerCronJobManually };
