import { nvd as nvdHelper } from '../helpers';
import vulnerabilityRepository from '../repositories/vulnerabilities.repository';

class VulnerabilityService {
    async updateVulnerabilities() {
        const vulnerabilities = await nvdHelper.fetchVulnerabilities();

        const formattedVulnerabilities = vulnerabilities.map((vulnerability) => ({
            cveId: vulnerability.cve.id,
            description:
                vulnerability.cve.descriptions.find((desc) => desc.lang === 'en')?.value || 'No description available',
            publishedDate: new Date(vulnerability.cve.published)
        }));

        await vulnerabilityRepository.bulkUpsertVulnerabilities(formattedVulnerabilities);
        await vulnerabilityRepository.deleteOldVulnerabilities();
    }
}

export default new VulnerabilityService();
